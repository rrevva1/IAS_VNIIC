# Отчёт: версия с домашней машины — сущности БД, функционал и тестовые данные

Документ фиксирует состояние проекта по дампу `ias_vniic_14_02_26.sql` и коду в репозитории: новые сущности БД, реализованный функционал и данные о внесении тестовых данных (аудит, лицензии и др.).

---

## 1. Состояние БД (схема tech_accounting)

### 1.1. Все таблицы из дампа (ias_vniic_14_02_26.sql)

| Таблица | Назначение |
|---------|------------|
| **audit_events** | Журнал аудита (события, неизменяемые записи) |
| **desk_attachments** | Справочник вложений (файлы) |
| **dic_equipment_status** | Справочник статусов оборудования |
| **dic_task_status** | Справочник статусов заявок |
| **equip_history** | История изменений оборудования |
| **equipment** | Оборудование (учёт ТС) |
| **equipment_software** | Связь «оборудование ↔ установленное ПО» |
| **import_errors** | Ошибки импорта |
| **import_runs** | Запуски импорта |
| **licenses** | Лицензии ПО (срок действия, привязка к software) |
| **locations** | Места размещения (кабинеты, склады) |
| **migration** | Журнал миграций Yii2 |
| **nsi_change_log** | Журнал изменений НСИ |
| **part_char_values** | Значения характеристик оборудования |
| **permissions** | Разрешения |
| **role_permissions** | Связь ролей и разрешений |
| **roles** | Роли |
| **software** | Справочник программного обеспечения |
| **spr_chars** | Справочник характеристик |
| **spr_parts** | Справочник типов (частей) |
| **task_attachments** | Связь заявка–вложение |
| **task_equipment** | Связь заявка–оборудование |
| **task_history** | История заявок |
| **tasks** | Заявки Help Desk |
| **user_roles** | Связь пользователь–роль |
| **users** | Пользователи |

### 1.2. Новые/дополнительные сущности (модули «Аудит», «ПО и лицензии»)

- **audit_events** — журнал аудита: `event_time`, `actor_id`, `action_type`, `object_type`, `object_id`, `result_status`, `source_ip`, `user_agent`, `payload` (jsonb), `error_message`. Защита от изменения: триггер `trg_audit_events_immutable` + функция `prevent_update_delete()` (запрет UPDATE/DELETE).
- **software** — ПО: `id`, `name`, `version`, `created_at`. Созётся миграцией `m260213_120000_add_software_licenses`.
- **licenses** — лицензии: `id`, `software_id` (FK → software), `valid_until`, `notes`, `created_at`.
- **equipment_software** — установленное ПО на оборудовании: `equipment_id`, `software_id`, `installed_at`, `created_at`.

Миграция Yii2: `ias_uch_vnii/migrations/m260213_120000_add_software_licenses.php`.

---

## 2. Реализованный функционал в приложении

### 2.1. Модуль «Аудит»

- **Контроллер:** `ias_uch_vnii/controllers/AuditController.php`.
- **Доступ:** только администратор (`isAdministrator()`).
- **Действия:** `actionIndex()` — список событий из `audit_events` с подгрузкой связи `actor` (пользователь).
- **Фильтры:** по дате (`from`, `to`), по `actor_id`, `action_type`, `object_type`. Постраничный вывод (50 записей).
- **Модель:** `app\models\entities\AuditEvent` (только чтение).
- **Запись в журнал:** компонент `app\components\AuditLog::log($actionType, $objectType, $objectId, $resultStatus, $payload, $errorMessage)`. Вызовы из:
  - `UsersController` — смена/сброс пароля (`user.password_reset`);
  - `TasksController` — создание/обновление/удаление заявки (`task.create`, `task.update`, `task.delete`), удаление вложения (`attachment.delete`);
  - `ArmController` — создание/обновление оборудования (`equipment.create`, `equipment.update`).

### 2.2. Модуль «ПО и лицензии»

- **Контроллер:** `ias_uch_vnii/controllers/SoftwareController.php`.
- **Доступ:** только администратор.
- **Действия:** `actionIndex()` — вывод списка ПО (`Software::find()`) и лицензий с привязкой к ПО (`License::find()->with('software')`).
- **Модели:** `app\models\entities\Software`, `app\models\entities\License`, `app\models\entities\EquipmentSoftware`.

### 2.3. Остальные модули (без изменений сущностей)

- Help Desk (заявки), пользователи, АРМ (учёт ТС), импорт — по существующему коду и чек-листу `tests/ManualTestChecklist.md`.

---

## 3. Тестовые данные: где что лежит и как запускать

Вся информация о тестовых данных сосредоточена в папке **`tests/`**.

### 3.1. Реестр и общее описание

| Файл | Назначение |
|------|------------|
| **tests/README.md** | Описание папки: зачем тестовые данные, как наполнять БД и как удалять. |
| **tests/TEST_DATA_REGISTRY.md** | Реестр тестовых записей: таблицы, диапазоны ID (900001+), маркеры (SEED-, seed_user_, «Тест. кабинет» и т.д.), порядок удаления и готовый скрипт удаления. |
| **tests/ManualTestChecklist.md** | Чек-лист ручной проверки по модулям (Help Desk, пользователи, АРМ, ПО/лицензии, импорт, аудит). |

### 3.2. Скрипты наполнения тестовыми данными

| Скрипт | Что заполняет | Запуск |
|--------|----------------|--------|
| **tests/seed_audit_only.sql** | Только журнал аудита: 25 записей в `audit_events` (разные `action_type`, `object_type`, `result_status`, `payload` с `"seed": true`). | `psql -U postgres -d ias_vniic -f tests/seed_audit_only.sql` |
| **tests/seed_software_licenses_only.sql** | Только «ПО и лицензии»: 10 записей в `software` (id 900001–900010, в т.ч. названия вроде Microsoft Windows 10 Pro, 1C и т.д.), затем лицензии по этим ПО. Перед запуском нужна миграция `m260213_120000_add_software_licenses`. | `psql -U postgres -d ias_vniic -f tests/seed_software_licenses_only.sql` |
| **tests/seed_test_data.sql** | Полное наполнение: локации, пользователи, справочники, оборудование, заявки, вложения, при необходимости software/licenses и др. Все тестовые ID в диапазоне 900001+. | `psql -U postgres -d ias_vniic -f tests/seed_test_data.sql` |

В `tests/README.md` указано: для модуля «ПО и лицензии» сначала выполнить миграции Yii2, при необходимости затем только ПО и лицензии — `seed_software_licenses_only.sql`; полное наполнение — `seed_test_data.sql`.

### 3.3. Удаление тестовых данных

- **tests/remove_test_data.sql** — готовый скрипт удаления тестовых записей (в порядке зависимостей). Запуск: `psql -U postgres -d ias_vniic -f tests/remove_test_data.sql`.
- В **tests/TEST_DATA_REGISTRY.md** описан порядок удаления по таблицам и команды для ручного выполнения.
- Особенность: в `audit_events` включён триггер неизменяемости (UPDATE/DELETE запрещены). Удаление тестовых записей аудита возможно только после отключения триггера (допустимо только в тестовой БД).

### 3.4. Что именно в дампе ias_vniic_14_02_26.sql по тестовым данным

В дампе с домашней машины уже присутствуют:

- **audit_events:** 25 записей с `payload` вида `{"i": N, "seed": true}` и разными `action_type` (task.create, task.update, user.login, equipment.view и т.д.), `result_status` (success, error, denied).
- **licenses:** 10 записей с `software_id` 900001–900010, `valid_until` в 2027 году, примечание «Тестовая лицензия для проверки раздела».
- **software:** в дампе есть данные для id 900001–900010 (в т.ч. SEED-SW-10 и др.) — согласовано с тем, что даёт `seed_software_licenses_only.sql` / полный seed.

То есть тестовые данные по аудиту и по лицензиям (и связанному ПО) уже были внесены на домашней машине и попали в дамп.

---

## 4. Краткая сводка

- **Новые сущности БД:** `audit_events`, `software`, `licenses`, `equipment_software` (миграция `m260213_120000_add_software_licenses` + DDL аудита в скриптах/дампе).
- **Реализованный функционал:** просмотр журнала аудита (с фильтрами); просмотр справочника ПО и лицензий; запись в аудит из контроллеров пользователей, заявок и оборудования.
- **Тестовые данные:** описаны и лежат в `tests/`: реестр — `TEST_DATA_REGISTRY.md`, скрипты — `seed_audit_only.sql`, `seed_software_licenses_only.sql`, `seed_test_data.sql`, удаление — `remove_test_data.sql` и блоки в реестре. В дампе `ias_vniic_14_02_26.sql` уже есть тестовые записи по аудиту и лицензиям (ПО).
