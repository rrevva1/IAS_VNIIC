{% extends "base.html" %}

{% block title %}Заявки (AG Grid) — IAS{% endblock %}

{% block extra_head %}
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@34.2.0/styles/ag-grid.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/ag-grid-community@34.2.0/styles/ag-theme-quartz.css"
  />
{% endblock %}

{% block content %}
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h4 mb-0">Заявки (AG Grid)</h1>
    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary" href="{% url 'tasks:list' %}">Обычный список</a>
      <a class="btn btn-primary" href="{% url 'tasks:create' %}">Создать заявку</a>
    </div>
  </div>

  <div class="d-flex gap-2 mb-3">
    <button class="btn btn-outline-primary" id="exportCsv">CSV</button>
    <a class="btn btn-outline-primary" href="{% url 'tasks:export_excel' %}">Excel</a>
  </div>

  <div id="tasksGrid" class="ag-theme-quartz" style="height: 600px;"></div>
{% endblock %}

{% block extra_js %}
  <script src="https://cdn.jsdelivr.net/npm/ag-grid-community@34.2.0/dist/ag-grid-community.min.js"></script>
  <script>
    const columnDefs = [
      { headerName: "ID", field: "id", width: 90 },
      { headerName: "Статус", field: "status", width: 140 },
      { headerName: "Описание", field: "description", flex: 1 },
      { headerName: "Автор", field: "creator", width: 180 },
      { headerName: "Исполнитель", field: "executor", width: 180 },
      { headerName: "Создана", field: "created_at", width: 150 },
      { headerName: "Обновлена", field: "updated_at", width: 150 },
      { headerName: "Вложения", field: "attachments", width: 110 },
      {
        headerName: "Открыть",
        field: "detail_url",
        width: 120,
        cellRenderer: params => `<a href="${params.value}">Просмотр</a>`
      }
    ];

    const gridOptions = {
      columnDefs,
      rowData: [],
      pagination: true,
      paginationPageSize: 25,
      defaultColDef: { sortable: true, filter: true, resizable: true },
    };

    const gridDiv = document.querySelector("#tasksGrid");
    agGrid.createGrid(gridDiv, gridOptions);

    fetch("{% url 'tasks:grid_data' %}")
      .then(resp => resp.json())
      .then(data => gridOptions.api.setRowData(data.rows));

    document.getElementById("exportCsv").addEventListener("click", () => {
      gridOptions.api.exportDataAsCsv({ fileName: "tasks.csv" });
    });
  </script>
{% endblock %}
